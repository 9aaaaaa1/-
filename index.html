<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>全功能TXT查重工具（含筛选+分组导出）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 960px; margin: 20px auto; padding: 10px 30px; }
    h1,h2 { text-align: center; }
    .dropzone {
      border: 2px dashed #888;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      color: #666;
      margin-bottom: 20px;
      user-select: none;
      transition: background 0.3s;
    }
    .dropzone.dragover {
      background: #f0f8ff;
      border-color: #007bff;
    }
    button {
      margin: 6px 6px 10px 0;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      color: white;
      background-color: #3f51b5;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #303f9f;
    }
    textarea {
      width: 100%;
      height: 180px;
      white-space: pre-wrap;
      margin-top: 10px;
      resize: vertical;
    }
    label {
      margin-right: 10px;
      user-select: none;
    }
    input[type="text"], input[type="number"] {
      padding: 6px;
      margin-right: 20px;
      width: 160px;
    }
    .filters {
      margin-bottom: 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }
    .stats span {
      display: inline-block;
      margin-right: 16px;
      font-weight: bold;
    }
    .center { text-align: center; }
    hr {
      margin: 30px 0;
      border: none;
      border-top: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h1>全功能TXT查重工具</h1>

<div class="dropzone" id="dropzone">请依次拖入两个 .txt 文件</div>

<div class="center">
  <button onclick="compareFiles()">开始查重</button>
  <button onclick="applyFilter()">筛选重复内容</button>
  <button onclick="downloadDuplicates()">导出重复内容</button>
  <button onclick="exportDuplicatesToExcel()">导出重复内容 Excel</button>
  <button onclick="downloadUniqueFiles()">导出文件去重结果</button>
  <button onclick="exportUniqueFile1ToExcel()">导出文件1去重 Excel</button>
  <button onclick="exportUniqueFile2ToExcel()">导出文件2去重 Excel</button>
  <button onclick="exportCombinedUniqueToExcel()">导出两文件去重合并 Excel</button>
  <button onclick="downloadGroupedFiles()">分组导出重复内容</button>
  <button onclick="resetAll()">清除文件</button>
</div>

<h3>筛选条件：</h3>
<div class="filters">
  <label>关键词：
    <input type="text" id="filterKeyword" placeholder="多个用逗号隔开" />
  </label>
  <label>正则表达式：
    <input type="text" id="filterRegex" placeholder="如：^\\d{11}$" />
  </label>
  <label>最小长度：
    <input type="number" id="filterMinLen" min="0" value="0" />
  </label>
  <label><input type="checkbox" id="filterIgnoreCase" checked /> 忽略大小写</label>
</div>

<h2>重复内容（两个文件共有的唯一行） - 筛选后内容动态显示：</h2>
<textarea id="result" readonly placeholder="重复内容将在此处显示"></textarea>

<hr />

<div class="stats" id="stats"></div>

<canvas id="chart" style="margin-top: 40px; max-height: 350px;"></canvas>
<script>
let file1 = null, file2 = null;
let duplicates = [], filteredDuplicates = [];
let unique1 = [], unique2 = [];
let lines1 = [], lines2 = [];

const dropzone = document.getElementById('dropzone');

dropzone.addEventListener('dragover', e => {
  e.preventDefault();
  dropzone.classList.add('dragover');
});
dropzone.addEventListener('dragleave', () => {
  dropzone.classList.remove('dragover');
});
dropzone.addEventListener('drop', e => {
  e.preventDefault();
  dropzone.classList.remove('dragover');
  const txtFiles = [...e.dataTransfer.files].filter(f => f.name.endsWith('.txt'));
  for (const file of txtFiles) {
    if (!file1) file1 = file;
    else if (!file2 && file.name !== file1.name) file2 = file;
  }
  updateDropzoneText();
});

function updateDropzoneText() {
  let text = '已加载文件：\n';
  if (file1) text += `1. ${file1.name}\n`;
  if (file2) text += `2. ${file2.name}`;
  dropzone.innerText = text;
}

function readFileLines(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const arr = reader.result.split('\n').map(l => l.trim()).filter(l => l);
      resolve(arr);
    };
    reader.onerror = reject;
    reader.readAsText(file);
  });
}

function countInternalDuplicates(lines) {
  const seen = new Set(), dup = new Set();
  for (const line of lines) {
    if (seen.has(line)) dup.add(line);
    seen.add(line);
  }
  return dup.size;
}

async function compareFiles() {
  if (!file1 || !file2) {
    alert('请先拖入两个 txt 文件');
    return;
  }
  [lines1, lines2] = await Promise.all([readFileLines(file1), readFileLines(file2)]);
  const set1 = new Set(lines1);
  const set2 = new Set(lines2);
  duplicates = [...set1].filter(line => set2.has(line));
  filteredDuplicates = duplicates.slice();

  const countFile2DupInFile1 = lines2.filter(line => set1.has(line)).length;
  const internalDup1 = countInternalDuplicates(lines1);
  const internalDup2 = countInternalDuplicates(lines2);
  unique1 = [...new Set(lines1)];
  unique2 = [...new Set(lines2)];

  document.getElementById('result').value = filteredDuplicates.length ? filteredDuplicates.join('\n') : '没有找到重复内容。';
  document.getElementById('stats').innerHTML = `
    <span>文件 1 总行数：${lines1.length}</span>
    <span>文件 1 内部重复行数：${internalDup1}</span><br>
    <span>文件 2 总行数：${lines2.length}</span>
    <span>文件 2 内部重复行数：${internalDup2}</span><br>
    <span>重复内容（唯一行数）：${duplicates.length}</span>
    <span>文件 2 中 ${countFile2DupInFile1} 行出现在文件 1 中</span>
  `;

  drawChart({ file1: lines1.length, dup1: internalDup1, file2: lines2.length, dup2: internalDup2, bothDup: duplicates.length, file2repeatIn1: countFile2DupInFile1 });
}

function applyFilter() {
  if (duplicates.length === 0) {
    alert('请先点击“开始查重”生成重复内容');
    return;
  }
  let filtered = duplicates.slice();
  const kwInput = document.getElementById('filterKeyword').value.trim();
  const regexInput = document.getElementById('filterRegex').value.trim();
  const minLenInput = parseInt(document.getElementById('filterMinLen').value) || 0;
  const ignoreCase = document.getElementById('filterIgnoreCase').checked;

  if (kwInput) {
    const kws = kwInput.split(',').map(s => s.trim()).filter(s => s);
    filtered = filtered.filter(line =>
      kws.some(kw => ignoreCase ? line.toLowerCase().includes(kw.toLowerCase()) : line.includes(kw))
    );
  }

  if (regexInput) {
    let reg = null;
    try {
      reg = new RegExp(regexInput, ignoreCase ? 'i' : '');
    } catch {
      alert('正则表达式错误！'); return;
    }
    filtered = filtered.filter(line => reg.test(line));
  }

  if (minLenInput > 0) {
    filtered = filtered.filter(line => line.length >= minLenInput);
  }

  filteredDuplicates = filtered;
  document.getElementById('result').value = filtered.length ? filtered.join('\n') : '筛选后无符合条件内容。';
}

function downloadFile(filename, content) {
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function downloadDuplicates() {
  if (filteredDuplicates.length === 0) {
    alert('无重复内容可导出');
    return;
  }
  downloadFile('重复内容_筛选后.txt', filteredDuplicates.join('\n'));
}

function downloadUniqueFiles() {
  const diff = unique1.filter(line => !new Set(lines2).has(line));
  if (diff.length > 0) downloadFile('文件1_去除文件2内容结果.txt', diff.join('\n'));
}

function downloadGroupedFiles() {
  if (filteredDuplicates.length === 0) {
    alert('无重复内容可分组导出'); return;
  }
  const groups = {};
  for (const line of filteredDuplicates) {
    let first = line[0] ? line[0].toUpperCase() : '#';
    if (!/[A-Z]/.test(first)) first = '#';
    if (!groups[first]) groups[first] = [];
    groups[first].push(line);
  }
  for (const key in groups) {
    downloadFile(`重复内容_${key}.txt`, groups[key].join('\n'));
  }
  alert('分组导出完成');
}

function exportToExcelWithHeader(data, filename) {
  const header = ['账号', '公钥', '私钥', '消息公钥', '消息私钥', 'hash'];
  const rows = data.map(line => line.split(','));
  const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "数据");
  XLSX.writeFile(wb, filename);
}

function exportDuplicatesToExcel() {
  if (filteredDuplicates.length === 0) {
    alert('无重复内容可导出');
    return;
  }
  exportToExcelWithHeader(filteredDuplicates, "重复内容.xlsx");
}

function exportUniqueFile1ToExcel() {
  if (unique1.length === 0) return;
  exportToExcelWithHeader(unique1, "文件1_去重结果.xlsx");
}

function exportUniqueFile2ToExcel() {
  if (unique2.length === 0) return;
  exportToExcelWithHeader(unique2, "文件2_去重结果.xlsx");
}

function exportCombinedUniqueToExcel() {
  const combinedSet = new Set([...unique1, ...unique2]);
  exportToExcelWithHeader([...combinedSet], "两个文件去重合并.xlsx");
}

function resetAll() {
  file1 = file2 = null;
  duplicates = filteredDuplicates = [];
  unique1 = unique2 = [];
  lines1 = lines2 = [];
  document.getElementById('dropzone').innerText = '请依次拖入两个 .txt 文件';
  document.getElementById('result').value = '';
  document.getElementById('stats').innerHTML = '';
  document.getElementById('filterKeyword').value = '';
  document.getElementById('filterRegex').value = '';
  document.getElementById('filterMinLen').value = '0';
  document.getElementById('filterIgnoreCase').checked = true;
  const chart = Chart.getChart("chart");
  if (chart) chart.destroy();
}

function drawChart(data) {
  const ctx = document.getElementById('chart').getContext('2d');
  const chart = Chart.getChart("chart");
  if (chart) chart.destroy();
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [
        '文件1总行数', '文件1内部重复',
        '文件2总行数', '文件2内部重复',
        '唯一重复行数', '文件2出现在文件1中'
      ],
      datasets: [{
        label: '数量',
        data: [data.file1, data.dup1, data.file2, data.dup2, data.bothDup, data.file2repeatIn1],
        backgroundColor: ['#4285F4', '#EA4335', '#34A853', '#FBBC05', '#AA66CC', '#FF7043']
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
}
</script>
</body>
</html>
